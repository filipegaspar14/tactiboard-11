<!DOCTYPE html>
<html lang="pt">
<head>
<meta charset="UTF-8">
<title>TactiBoard 11 – Campo Verde 2D</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<style>
  body { margin:0; font-family:'Segoe UI',sans-serif; background:#f8f9fa; color:#111; }
  header { padding:16px; background:#22c55e; text-align:center; font-size:26px; font-weight:bold; color:white; }
  .container { display:flex; gap:20px; padding:16px; max-width:100%; margin:auto; flex-wrap:wrap; }
  .sidebar { width:320px; min-width:280px; background:#e0f2e9; padding:16px; border-radius:10px; box-shadow:0 2px 10px rgba(0,0,0,0.1); }
  .sidebar input, .sidebar select, .sidebar button { width:100%; margin:8px 0; padding:10px; border-radius:6px; border:1px solid #ccc; box-sizing:border-box; font-size:14px; }
  .sidebar button.primary   { background:#16a34a; color:white; border:none; cursor:pointer; }
  .sidebar button.secondary { background:#6b7280; color:white; border:none; cursor:pointer; }
  .sidebar button.danger    { background:#ef4444; color:white; border:none; cursor:pointer; }

  .player-slot { display:flex; align-items:center; background:white; border:1px solid #ddd; border-radius:6px; margin:6px 0; padding:6px; font-weight:bold; cursor:grab; }
  .player-number { width:36px; text-align:center; background:#dcfce7; border-radius:4px; padding:4px 0; margin-right:8px; color:#166534; }
  .player-name { flex:1; padding:6px; min-height:24px; }
  .player-name:focus { outline:2px solid #16a34a; background:#f0fdf4; }

  .field-container { flex:1; min-width:600px; text-align:center; }
  .field { width:100%; max-width:920px; height:520px; background:#86efac; margin:0 auto; position:relative; border:4px solid #14532d; border-radius:8px; overflow:hidden; box-shadow:0 4px 20px rgba(0,0,0,0.15); }

  .player { position:absolute; width:76px; height:46px; border-radius:10px; text-align:center; line-height:46px; font-size:13px; font-weight:bold; cursor:move; background:rgba(255,255,255,0.94); color:#111; border:1px solid #555; box-shadow:0 2px 8px rgba(0,0,0,0.25); user-select:none; }
  .player::before { content:attr(data-pos); position:absolute; top:-20px; left:50%; transform:translateX(-50%); font-size:11px; color:#222; font-weight:normal; }
</style>
</head>
<body>

<header>⚽ TactiBoard 11 – Campo Verde 2D</header>

<div class="container">
  <div class="sidebar">
    <input type="text" id="teamName" placeholder="Nome da Equipa">
    <input type="text" id="opponent" placeholder="Adversário">
    <input type="date" id="matchDate">
    <input type="text" id="competition" placeholder="Competição">

    <select id="formation" onchange="generateFormation()">
      <option value="352Atual" selected>3-5-2 ATUAL (Preset)</option>
      <option value="433">4-3-3</option>
      <option value="442">4-4-2</option>
      <option value="4231">4-2-3-1</option>
      <option value="532">5-3-2</option>
    </select>

    <button class="primary" onclick="generateFormation()">Aplicar Formação</button>
    <button class="secondary" onclick="clearPositions()">Limpar Campo</button>
    <button class="danger" onclick="resetAll()">Reset Total</button>

    <div style="margin-top:24px;">
      <h3>Plantel (1–18)</h3>
      <div id="playerList"></div>
      <input type="text" id="newPlayer" placeholder="Adicionar jogador extra">
      <button class="primary" onclick="addExtraPlayer()">Adicionar</button>
    </div>

    <!-- Botão novo para PDF com lista -->
    <button class="primary" style="margin-top:20px; background:#7c3aed;" onclick="generatePDFWithPlayerList()">
      Gerar PDF (campo + lista 18 jogadores)
    </button>
  </div>

  <div class="field-container">
    <div class="field" id="field"></div>
  </div>
</div>

<script>
const field = document.getElementById("field");
let draggedElement = null;
let offsetX, offsetY;
let playerNames = Array(18).fill("");

// =============================================
// Desenhar campo (mantém a tua versão corrigida)
// =============================================
function drawFieldLines() {
  const svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
  svg.setAttribute("width", "100%");
  svg.setAttribute("height", "100%");
  svg.style.position = "absolute";
  svg.style.top = "0";
  svg.style.left = "0";
  svg.style.pointerEvents = "none";

  const w = 920, h = 520;
  const scaleX = w / 105;
  const scaleY = h / 68;

  const lines = [];
  lines.push(`<rect x="0" y="0" width="${w}" height="${h}" fill="none" stroke="#ffffff" stroke-width="4" opacity="0.85"/>`);
  lines.push(`<line x1="${w/2}" y1="0" x2="${w/2}" y2="${h}" stroke="#ffffff" stroke-width="3" opacity="0.75"/>`);
  lines.push(`<circle cx="${w/2}" cy="${h/2}" r="${9.15 * scaleX}" fill="none" stroke="#ffffff" stroke-width="3" opacity="0.75"/>`);
  lines.push(`<circle cx="${w/2}" cy="${h/2}" r="3" fill="#ffffff"/>`);

  const paDepth = 16.5 * scaleX;
  const paWidth = 40.32 * scaleY;
  lines.push(`<rect x="0" y="${(h - paWidth)/2}" width="${paDepth}" height="${paWidth}" fill="none" stroke="#ffffff" stroke-width="3" opacity="0.8"/>`);
  lines.push(`<rect x="${w - paDepth}" y="${(h - paWidth)/2}" width="${paDepth}" height="${paWidth}" fill="none" stroke="#ffffff" stroke-width="3" opacity="0.8"/>`);

  const gaDepth = 5.5 * scaleX;
  const gaWidth = 18.32 * scaleY;
  lines.push(`<rect x="0" y="${(h - gaWidth)/2}" width="${gaDepth}" height="${gaWidth}" fill="none" stroke="#ffffff" stroke-width="2.5" opacity="0.8"/>`);
  lines.push(`<rect x="${w - gaDepth}" y="${(h - gaWidth)/2}" width="${gaDepth}" height="${gaWidth}" fill="none" stroke="#ffffff" stroke-width="2.5" opacity="0.8"/>`);

  const penSpot = 11 * scaleX;
  lines.push(`<circle cx="${penSpot}" cy="${h/2}" r="2.5" fill="#ffffff"/>`);
  lines.push(`<circle cx="${w - penSpot}" cy="${h/2}" r="2.5" fill="#ffffff"/>`);

  const arcRadius = 9.15 * scaleX;
  lines.push(`<path d="M ${penSpot} ${h/2} A ${arcRadius} ${arcRadius} 0 0 1 ${penSpot + 18.3 * scaleY} ${h/2 - 9.15 * scaleY}" fill="none" stroke="#ffffff" stroke-width="3" opacity="0.8"/>`);
  lines.push(`<path d="M ${penSpot} ${h/2} A ${arcRadius} ${arcRadius} 0 0 0 ${penSpot + 18.3 * scaleY} ${h/2 + 9.15 * scaleY}" fill="none" stroke="#ffffff" stroke-width="3" opacity="0.8"/>`);
  lines.push(`<path d="M ${w - penSpot} ${h/2} A ${arcRadius} ${arcRadius} 0 0 0 ${w - penSpot - 18.3 * scaleY} ${h/2 - 9.15 * scaleY}" fill="none" stroke="#ffffff" stroke-width="3" opacity="0.8"/>`);
  lines.push(`<path d="M ${w - penSpot} ${h/2} A ${arcRadius} ${arcRadius} 0 0 1 ${w - penSpot - 18.3 * scaleY} ${h/2 + 9.15 * scaleY}" fill="none" stroke="#ffffff" stroke-width="3" opacity="0.8"/>`);

  const cornerR = 1 * scaleX;
  lines.push(`<path d="M 0 0 A ${cornerR} ${cornerR} 0 0 1 ${cornerR*2} ${cornerR*2}" fill="none" stroke="#ffffff" stroke-width="3" opacity="0.7"/>`);
  lines.push(`<path d="M ${w} 0 A ${cornerR} ${cornerR} 0 0 0 ${w - cornerR*2} ${cornerR*2}" fill="none" stroke="#ffffff" stroke-width="3" opacity="0.7"/>`);
  lines.push(`<path d="M 0 ${h} A ${cornerR} ${cornerR} 0 0 0 ${cornerR*2} ${h - cornerR*2}" fill="none" stroke="#ffffff" stroke-width="3" opacity="0.7"/>`);
  lines.push(`<path d="M ${w} ${h} A ${cornerR} ${cornerR} 0 0 1 ${w - cornerR*2} ${h - cornerR*2}" fill="none" stroke="#ffffff" stroke-width="3" opacity="0.7"/>`);

  svg.innerHTML = lines.join("\n");
  field.appendChild(svg);
}

// Inicializar plantel
function initPlantel() {
  const list = document.getElementById("playerList");
  list.innerHTML = "";
  for (let i = 0; i < 18; i++) {
    const slot = document.createElement("div");
    slot.className = "player-slot";
    slot.draggable = true;
    slot.dataset.index = i;

    const num = document.createElement("div");
    num.className = "player-number";
    num.innerText = i + 1;

    const nameDiv = document.createElement("div");
    nameDiv.className = "player-name";
    nameDiv.contentEditable = true;
    nameDiv.innerText = playerNames[i] || "";
    nameDiv.oninput = () => {
      playerNames[i] = nameDiv.innerText.trim();
    };

    slot.appendChild(num);
    slot.appendChild(nameDiv);

    list.appendChild(slot);
  }
}

function addExtraPlayer() {
  const name = document.getElementById("newPlayer").value.trim();
  if (!name) return;
  const slot = document.createElement("div");
  slot.className = "player-slot";

  const num = document.createElement("div");
  num.className = "player-number";
  num.innerText = "?";

  const nameDiv = document.createElement("div");
  nameDiv.className = "player-name";
  nameDiv.contentEditable = true;
  nameDiv.innerText = name;

  slot.appendChild(num);
  slot.appendChild(nameDiv);
  document.getElementById("playerList").appendChild(slot);
  document.getElementById("newPlayer").value = "";
}

// Formações (mantém as tuas)
const formations = {
  "352Atual": [[0.06, 0.50], [0.22, 0.32], [0.22, 0.50], [0.22, 0.68], [0.42, 0.12], [0.42, 0.32], [0.42, 0.50], [0.42, 0.68], [0.42, 0.88], [0.70, 0.35], [0.70, 0.65]],
  // ... adiciona as outras se quiseres
};

function generateFormation() {
  field.innerHTML = "";
  drawFieldLines();

  const key = document.getElementById("formation").value;
  const pos = formations[key] || formations["352Atual"];

  pos.forEach((p, i) => {
    if (i >= 11) return;
    const div = document.createElement("div");
    div.className = "player";
    div.contentEditable = true;
    div.dataset.pos = (i + 1).toString();
    div.innerText = playerNames[i] || "";
    div.style.left = (p[0] * 920) + "px";
    div.style.top = (p[1] * 520) + "px";
    makeDraggable(div);
    field.appendChild(div);
  });
}

// Função nova: PDF com campo na página 1 + lista na página 2
async function generatePDFWithPlayerList() {
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF({ orientation: "landscape", unit: "mm", format: "a4" });

  // Página 1: o campo
  const canvas = await html2canvas(field, { scale: 3, backgroundColor: null });
  const imgData = canvas.toDataURL("image/png");
  const imgW = 270;
  const imgH = (canvas.height / canvas.width) * imgW;
  pdf.addImage(imgData, "PNG", 10, 10, imgW, imgH);

  // Página 2: lista dos 18 jogadores
  pdf.addPage();

  pdf.setFontSize(18);
  pdf.text("Lista de Jogadores - " + (document.getElementById("teamName").value || "Equipa"), 20, 25);

  pdf.setFontSize(14);
  pdf.text("Plantel (1 a 18)", 20, 40);

  pdf.setFontSize(12);
  let y = 55;
  const players = document.querySelectorAll("#playerList .player-slot");
  players.forEach((slot, index) => {
    const number = slot.querySelector(".player-number").innerText;
    const name = slot.querySelector(".player-name").innerText.trim() || "(vazio)";
    pdf.text(`${number.padEnd(4)} ${name}`, 25, y);
    y += 10;

    // Quebra de página automática se passar do limite (A4 landscape ~ ~270mm altura útil)
    if (y > 190) {
      pdf.addPage();
      y = 20;
    }
  });

  // Rodapé simples
  pdf.setFontSize(10);
  pdf.text("Gerado por TactiBoard 11 – " + new Date().toLocaleDateString("pt-PT"), 20, 200);

  pdf.save("TactiBoard_Campo_e_Lista_Jogadores.pdf");
}

// Funções de drag (mantém as tuas anteriores – makeDraggable, etc.)
function makeDraggable(el) {
  // ... copia a tua função makeDraggable aqui
}

// Limpar, reset, etc. (mantém as tuas)
function clearPositions() { field.innerHTML = ""; drawFieldLines(); }
function resetAll() {
  if (confirm("Reset total?")) {
    playerNames.fill("");
    initPlantel();
    clearPositions();
    generateFormation();
  }
}

// Inicialização
initPlantel();
drawFieldLines();
generateFormation();
</script>
</body>
</html>
