<!DOCTYPE html>
<html lang="pt">
<head>
<meta charset="UTF-8">
<title>TactiBoard 11 – Campo Verde 2D</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<style>
  body { margin:0; font-family:'Segoe UI',sans-serif; background:#f8f9fa; color:#111; }
  header { padding:16px; background:#22c55e; text-align:center; font-size:26px; font-weight:bold; color:white; }
  .container { display:flex; gap:20px; padding:16px; max-width:100%; margin:auto; flex-wrap:wrap; }
  .sidebar { width:320px; min-width:280px; background:#e0f2e9; padding:16px; border-radius:10px; box-shadow:0 2px 10px rgba(0,0,0,0.1); }
  .sidebar input, .sidebar select, .sidebar button { width:100%; margin:8px 0; padding:10px; border-radius:6px; border:1px solid #ccc; box-sizing:border-box; font-size:14px; }
  .sidebar button.primary   { background:#16a34a; color:white; border:none; cursor:pointer; }
  .sidebar button.secondary { background:#6b7280; color:white; border:none; cursor:pointer; }
  .sidebar button.danger    { background:#ef4444; color:white; border:none; cursor:pointer; }

  .player-slot { display:flex; align-items:center; background:white; border:1px solid #ddd; border-radius:6px; margin:6px 0; padding:6px; font-weight:bold; cursor:grab; }
  .player-number { width:36px; text-align:center; background:#dcfce7; border-radius:4px; padding:4px 0; margin-right:8px; color:#166534; }
  .player-name { flex:1; padding:6px; min-height:24px; }
  .player-name:focus { outline:2px solid #16a34a; background:#f0fdf4; }

  .field-container { flex:1; min-width:600px; text-align:center; }
  .field { width:100%; max-width:920px; height:520px; background:#86efac; margin:0 auto; position:relative; border:4px solid #14532d; border-radius:8px; overflow:hidden; box-shadow:0 4px 20px rgba(0,0,0,0.15); }

  .player { position:absolute; width:76px; height:46px; border-radius:10px; text-align:center; line-height:46px; font-size:13px; font-weight:bold; cursor:move; background:rgba(255,255,255,0.94); color:#111; border:1px solid #555; box-shadow:0 2px 8px rgba(0,0,0,0.25); user-select:none; }
  .player::before { content:attr(data-pos); position:absolute; top:-20px; left:50%; transform:translateX(-50%); font-size:11px; color:#222; font-weight:normal; }
</style>
</head>
<body>

<header>⚽ TactiBoard 11 – Campo Verde 2D</header>

<div class="container">
  <div class="sidebar">
    <input type="text" id="teamName" placeholder="Nome da Equipa">
    <input type="text" id="opponent" placeholder="Adversário">
    <input type="date" id="matchDate">
    <input type="text" id="competition" placeholder="Competição">

    <select id="formation" onchange="generateFormation()">
      <option value="352Atual" selected>3-5-2 ATUAL (Preset)</option>
      <option value="433">4-3-3</option>
      <option value="442">4-4-2</option>
      <option value="4231">4-2-3-1</option>
      <option value="532">5-3-2</option>
    </select>

    <button class="primary" onclick="generateFormation()">Aplicar Formação</button>
    <button class="secondary" onclick="clearPositions()">Limpar Campo</button>
    <button class="danger" onclick="resetAll()">Reset Total</button>

    <div style="margin-top:24px;">
      <h3>Plantel (1–18)</h3>
      <div id="playerList"></div>
      <input type="text" id="newPlayer" placeholder="Adicionar jogador extra">
      <button class="primary" onclick="addExtraPlayer()">Adicionar</button>
    </div>

    <button class="primary" style="margin-top:20px; background:#7c3aed; width:100%;" onclick="generatePDFWithPlayerList()">
      Gerar PDF (campo + lista 18 jogadores)
    </button>
  </div>

  <div class="field-container">
    <div class="field" id="field"></div>
  </div>
</div>

<script>
const field = document.getElementById("field");
let draggedElement = null;
let offsetX, offsetY;
let playerNames = Array(18).fill("");

// =============================================
// Desenhar campo FIFA
// =============================================
function drawFieldLines() {
  const svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
  svg.setAttribute("width", "100%");
  svg.setAttribute("height", "100%");
  svg.style.position = "absolute";
  svg.style.top = "0";
  svg.style.left = "0";
  svg.style.pointerEvents = "none";

  const w = 920, h = 520;
  const scaleX = w / 105;
  const scaleY = h / 68;

  const lines = [];
  lines.push(`<rect x="0" y="0" width="${w}" height="${h}" fill="none" stroke="#ffffff" stroke-width="4" opacity="0.85"/>`);
  lines.push(`<line x1="${w/2}" y1="0" x2="${w/2}" y2="${h}" stroke="#ffffff" stroke-width="3" opacity="0.75"/>`);
  lines.push(`<circle cx="${w/2}" cy="${h/2}" r="${9.15 * scaleX}" fill="none" stroke="#ffffff" stroke-width="3" opacity="0.75"/>`);
  lines.push(`<circle cx="${w/2}" cy="${h/2}" r="3" fill="#ffffff"/>`);

  const paDepth = 16.5 * scaleX;
  const paWidth = 40.32 * scaleY;
  lines.push(`<rect x="0" y="${(h - paWidth)/2}" width="${paDepth}" height="${paWidth}" fill="none" stroke="#ffffff" stroke-width="3" opacity="0.8"/>`);
  lines.push(`<rect x="${w - paDepth}" y="${(h - paWidth)/2}" width="${paDepth}" height="${paWidth}" fill="none" stroke="#ffffff" stroke-width="3" opacity="0.8"/>`);

  const gaDepth = 5.5 * scaleX;
  const gaWidth = 18.32 * scaleY;
  lines.push(`<rect x="0" y="${(h - gaWidth)/2}" width="${gaDepth}" height="${gaWidth}" fill="none" stroke="#ffffff" stroke-width="2.5" opacity="0.8"/>`);
  lines.push(`<rect x="${w - gaDepth}" y="${(h - gaWidth)/2}" width="${gaDepth}" height="${gaWidth}" fill="none" stroke="#ffffff" stroke-width="2.5" opacity="0.8"/>`);

  const penSpot = 11 * scaleX;
  lines.push(`<circle cx="${penSpot}" cy="${h/2}" r="2.5" fill="#ffffff"/>`);
  lines.push(`<circle cx="${w - penSpot}" cy="${h/2}" r="2.5" fill="#ffffff"/>`);

  const arcRadius = 9.15 * scaleX;
  lines.push(`<path d="M ${penSpot} ${h/2} A ${arcRadius} ${arcRadius} 0 0 1 ${penSpot + 18.3 * scaleY} ${h/2 - 9.15 * scaleY}" fill="none" stroke="#ffffff" stroke-width="3" opacity="0.8"/>`);
  lines.push(`<path d="M ${penSpot} ${h/2} A ${arcRadius} ${arcRadius} 0 0 0 ${penSpot + 18.3 * scaleY} ${h/2 + 9.15 * scaleY}" fill="none" stroke="#ffffff" stroke-width="3" opacity="0.8"/>`);
  lines.push(`<path d="M ${w - penSpot} ${h/2} A ${arcRadius} ${arcRadius} 0 0 0 ${w - penSpot - 18.3 * scaleY} ${h/2 - 9.15 * scaleY}" fill="none" stroke="#ffffff" stroke-width="3" opacity="0.8"/>`);
  lines.push(`<path d="M ${w - penSpot} ${h/2} A ${arcRadius} ${arcRadius} 0 0 1 ${w - penSpot - 18.3 * scaleY} ${h/2 + 9.15 * scaleY}" fill="none" stroke="#ffffff" stroke-width="3" opacity="0.8"/>`);

  const cornerR = 1 * scaleX;
  lines.push(`<path d="M 0 0 A ${cornerR} ${cornerR} 0 0 1 ${cornerR*2} ${cornerR*2}" fill="none" stroke="#ffffff" stroke-width="3" opacity="0.7"/>`);
  lines.push(`<path d="M ${w} 0 A ${cornerR} ${cornerR} 0 0 0 ${w - cornerR*2} ${cornerR*2}" fill="none" stroke="#ffffff" stroke-width="3" opacity="0.7"/>`);
  lines.push(`<path d="M 0 ${h} A ${cornerR} ${cornerR} 0 0 0 ${cornerR*2} ${h - cornerR*2}" fill="none" stroke="#ffffff" stroke-width="3" opacity="0.7"/>`);
  lines.push(`<path d="M ${w} ${h} A ${cornerR} ${cornerR} 0 0 1 ${w - cornerR*2} ${h - cornerR*2}" fill="none" stroke="#ffffff" stroke-width="3" opacity="0.7"/>`);

  svg.innerHTML = lines.join("\n");
  field.appendChild(svg);
}

// =============================================
// Plantel
// =============================================
function initPlantel() {
  const list = document.getElementById("playerList");
  list.innerHTML = "";
  for (let i = 0; i < 18; i++) {
    const slot = document.createElement("div");
    slot.className = "player-slot";
    slot.draggable = true;
    slot.dataset.index = i;

    const num = document.createElement("div");
    num.className = "player-number";
    num.innerText = i + 1;

    const nameDiv = document.createElement("div");
    nameDiv.className = "player-name";
    nameDiv.contentEditable = true;
    nameDiv.innerText = playerNames[i] || "";
    nameDiv.oninput = () => {
      playerNames[i] = nameDiv.innerText.trim();
    };

    slot.appendChild(num);
    slot.appendChild(nameDiv);
    list.appendChild(slot);
  }
}

function addExtraPlayer() {
  const name = document.getElementById("newPlayer").value.trim();
  if (!name) return;
  const slot = document.createElement("div");
  slot.className = "player-slot";

  const num = document.createElement("div");
  num.className = "player-number";
  num.innerText = "?";

  const nameDiv = document.createElement("div");
  nameDiv.className = "player-name";
  nameDiv.contentEditable = true;
  nameDiv.innerText = name;

  slot.appendChild(num);
  slot.appendChild(nameDiv);
  document.getElementById("playerList").appendChild(slot);
  document.getElementById("newPlayer").value = "";
}

// =============================================
// Formações
// =============================================
const formations = {
  "352Atual": [
    [0.06, 0.50], [0.22, 0.32], [0.22, 0.50], [0.22, 0.68],
    [0.42, 0.12], [0.42, 0.32], [0.42, 0.50], [0.42, 0.68], [0.42, 0.88],
    [0.70, 0.35], [0.70, 0.65]
  ],
  "433": [[0.06,0.5],[0.20,0.25],[0.20,0.50],[0.20,0.75],[0.20,0.90],[0.40,0.25],[0.40,0.50],[0.40,0.75],[0.68,0.20],[0.68,0.50],[0.68,0.80]],
  "442": [[0.06,0.5],[0.20,0.25],[0.20,0.50],[0.20,0.75],[0.20,0.90],[0.42,0.20],[0.42,0.45],[0.42,0.55],[0.42,0.80],[0.70,0.35],[0.70,0.65]],
  "4231": [[0.06,0.5],[0.20,0.25],[0.20,0.50],[0.20,0.75],[0.20,0.90],[0.38,0.35],[0.38,0.65],[0.55,0.20],[0.55,0.40],[0.55,0.60],[0.72,0.50]],
  "532": [[0.06,0.5],[0.18,0.20],[0.18,0.40],[0.18,0.60],[0.18,0.80],[0.18,0.95],[0.40,0.25],[0.40,0.50],[0.40,0.75],[0.68,0.35],[0.68,0.65]]
};

function generateFormation() {
  field.innerHTML = "";
  drawFieldLines();

  const key = document.getElementById("formation").value;
  const pos = formations[key] || formations["352Atual"];

  pos.forEach((p, i) => {
    if (i >= 11) return;
    const div = document.createElement("div");
    div.className = "player";
    div.contentEditable = true;
    div.dataset.pos = (i + 1).toString();
    div.innerText = playerNames[i] || "";
    div.style.left = (p[0] * 920) + "px";
    div.style.top = (p[1] * 520) + "px";
    makeDraggable(div);
    field.appendChild(div);
  });
}

// =============================================
// Drag & Drop (básico – podes expandir com snap/touch)
// =============================================
function makeDraggable(el) {
  let isDragging = false;

  const start = e => {
    isDragging = true;
    const clientX = e.clientX || (e.touches && e.touches[0].clientX);
    const clientY = e.clientY || (e.touches && e.touches[0].clientY);
    const rect = el.getBoundingClientRect();
    offsetX = clientX - rect.left;
    offsetY = clientY - rect.top;
    el.style.zIndex = 100;
    e.preventDefault();
  };

  const move = e => {
    if (!isDragging) return;
    e.preventDefault();
    const clientX = e.clientX || (e.touches && e.touches[0].clientX);
    const clientY = e.clientY || (e.touches && e.touches[0].clientY);
    let newLeft = clientX - offsetX - field.getBoundingClientRect().left;
    let newTop = clientY - offsetY - field.getBoundingClientRect().top;

    newLeft = Math.round(newLeft / 10) * 10; // snap mais fino
    newTop = Math.round(newTop / 10) * 10;
    newLeft = Math.max(0, Math.min(920-76, newLeft));
    newTop = Math.max(0, Math.min(520-46, newTop));

    el.style.left = newLeft + "px";
    el.style.top = newTop + "px";
  };

  const end = () => isDragging = false;

  el.addEventListener("mousedown", start);
  el.addEventListener("touchstart", start, {passive: false});
  document.addEventListener("mousemove", move);
  document.addEventListener("touchmove", move, {passive: false});
  document.addEventListener("mouseup", end);
  document.addEventListener("touchend", end);
}

field.addEventListener("dragover", e => e.preventDefault());

field.addEventListener("drop", e => {
  e.preventDefault();
  if (!draggedElement) return;

  const data = e.dataTransfer.getData("text/plain");
  const idx = parseInt(data);
  if (isNaN(idx)) return;

  const rect = field.getBoundingClientRect();
  let left = e.clientX - rect.left - 38;
  let top = e.clientY - rect.top - 23;
  left = Math.round(left / 10) * 10;
  top = Math.round(top / 10) * 10;

  const div = document.createElement("div");
  div.className = "player";
  div.contentEditable = true;
  div.innerText = playerNames[idx] || "";
  div.dataset.pos = "?";
  div.style.left = Math.max(0, Math.min(920-76, left)) + "px";
  div.style.top = Math.max(0, Math.min(520-46, top)) + "px";

  makeDraggable(div);
  field.appendChild(div);
});

// =============================================
// Limpar e Reset
// =============================================
function clearPositions() {
  field.innerHTML = "";
  drawFieldLines();
}

function resetAll() {
  if (!confirm("Reset total? Perdes tudo.")) return;
  document.getElementById("teamName").value = "";
  document.getElementById("opponent").value = "";
  document.getElementById("matchDate").value = "";
  document.getElementById("competition").value = "";
  playerNames.fill("");
  initPlantel();
  clearPositions();
  generateFormation();
}

// =============================================
// PDF com cabeçalho nas duas páginas
// =============================================
async function generatePDFWithPlayerList() {
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF({ orientation: "landscape", unit: "mm", format: "a4" });

  // Dados do cabeçalho
  const teamName = document.getElementById("teamName").value.trim() || "Equipa";
  const opponentName = document.getElementById("opponent").value.trim() || "Adversário";
  const matchDate = document.getElementById("matchDate").value || "—";
  const headerText = `${teamName} vs ${opponentName} – ${matchDate}`;

  // Página 1: campo
  const canvas = await html2canvas(field, { scale: 3, backgroundColor: null });
  const imgData = canvas.toDataURL("image/png");
  const imgW = 270;
  const imgH = (canvas.height / canvas.width) * imgW;

  pdf.setFontSize(16);
  pdf.setTextColor(40);
  pdf.text(headerText, 148.5, 12, { align: "center" });
  pdf.setLineWidth(0.5);
  pdf.line(10, 15, 287, 15);

  pdf.addImage(imgData, "PNG", 10, 20, imgW, imgH);

  // Página 2: lista + mesmo cabeçalho
  pdf.addPage();

  pdf.setFontSize(16);
  pdf.setTextColor(40);
  pdf.text(headerText, 148.5, 12, { align: "center" });
  pdf.line(10, 15, 287, 15);

  pdf.setFontSize(18);
  pdf.text("Lista de Jogadores", 20, 35);

  pdf.setFontSize(14);
  pdf.text("Plantel (1 a 18)", 20, 48);

  pdf.setFontSize(12);
  let y = 65;
  const players = document.querySelectorAll("#playerList .player-slot");

  players.forEach((slot) => {
    const number = slot.querySelector(".player-number").innerText;
    const name = slot.querySelector(".player-name").innerText.trim() || "(sem nome)";
    pdf.text(`${number.padEnd(5)} ${name}`, 25, y);
    y += 10;

    if (y > 190) {
      pdf.addPage();
      pdf.setFontSize(16);
      pdf.text(headerText, 148.5, 12, { align: "center" });
      pdf.line(10, 15, 287, 15);
      y = 30;
    }
  });

  pdf.setFontSize(10);
  pdf.setTextColor(100);
  pdf.text("Gerado por TactiBoard 11 – " + new Date().toLocaleDateString("pt-PT"), 20, 200);

  pdf.save(`TactiBoard_${teamName.replace(/\s+/g, '_')}_vs_${opponentName.replace(/\s+/g, '_')}.pdf`);
}

// Inicialização
initPlantel();
drawFieldLines();
generateFormation();
</script>
</body>
</html>
