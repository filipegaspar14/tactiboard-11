<!DOCTYPE html>
<html lang="pt">
<head>
<meta charset="UTF-8">
<title>TactiBoard 11 – Campo Verde 2D</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<style>
  body {margin:0; font-family:'Segoe UI',sans-serif; background:#f8f9fa; color:#111;}
  header {padding:16px; background:#22c55e; text-align:center; font-size:26px; font-weight:bold; color:white;}
  .container {display:flex; gap:24px; padding:20px; max-width:1400px; margin:auto;}
  .sidebar {width:340px; background:#e0f2e9; padding:20px; border-radius:12px; box-shadow:0 2px 10px rgba(0,0,0,0.08);}
  .sidebar input, .sidebar select {width:100%; margin-bottom:12px; padding:10px; border-radius:6px; border:1px solid #ccc; box-sizing:border-box;}
  .sidebar button {width:100%; padding:12px; margin:6px 0; border:none; border-radius:8px; font-weight:bold; cursor:pointer;}
  .sidebar button.primary   {background:#16a34a; color:white;}
  .sidebar button.secondary {background:#6b7280; color:white;}
  .sidebar button.danger    {background:#ef4444; color:white;}
  
  .player-slot {display:flex; align-items:center; background:white; border:1px solid #ddd; border-radius:6px; margin:6px 0; padding:6px; font-weight:bold;}
  .player-number {width:36px; text-align:center; background:#dcfce7; border-radius:4px; padding:4px 0; margin-right:8px; color:#166534; font-size:15px;}
  .player-name {flex:1; padding:6px; border-radius:4px; min-height:24px;}
  .player-name[contenteditable="true"]:focus {outline:2px solid #16a34a; background:#f0fdf4;}
  
  .field-container {flex:1; text-align:center;}
  .field {width:920px; height:520px; background:#86efac; margin:auto; position:relative; border:4px solid #14532d; border-radius:8px; overflow:hidden; box-shadow:0 4px 20px rgba(0,0,0,0.15);}
  .player {position:absolute; width:76px; height:46px; border-radius:10px; text-align:center; line-height:46px; font-size:13px; font-weight:bold; cursor:move; background:rgba(255,255,255,0.94); color:#111; border:1px solid #555; box-shadow:0 2px 8px rgba(0,0,0,0.25); user-select:none;}
  .player::before {content:attr(data-pos); position:absolute; top:-20px; left:50%; transform:translateX(-50%); font-size:11px; color:#222; font-weight:normal;}
</style>
</head>
<body>

<header>⚽ TactiBoard 11 – Campo Verde 2D</header>

<div class="container">
  <div class="sidebar">
    <input type="text" id="teamName" placeholder="Nome da Equipa">
    <input type="text" id="opponent" placeholder="Adversário">
    <input type="date" id="matchDate">
    <input type="text" id="competition" placeholder="Competição">

    <select id="formation">
      <option value="352Atual" selected>3-5-2 ATUAL (Preset)</option>
      <option value="433">4-3-3</option>
      <option value="442">4-4-2</option>
      <option value="4231">4-2-3-1</option>
      <option value="532">5-3-2</option>
    </select>

    <button class="primary" onclick="generateFormation()">Aplicar Formação</button>
    <button class="secondary" onclick="clearPositions()">Limpar posições</button>
    <button class="danger" onclick="resetAll()">Reset total</button>
    <button class="primary" onclick="downloadPDF()">Download PDF</button>

    <div style="margin-top:24px;">
      <h3>Plantel (1–18)</h3>
      <div id="playerList"></div>
      <input type="text" id="newPlayer" placeholder="Adicionar jogador extra (19+)">
      <button class="primary" onclick="addExtraPlayer()">Adicionar extra</button>
      <p style="font-size:12px; color:#555; margin-top:8px;">Edita os nomes • Arrasta para o campo</p>
    </div>
  </div>

  <div class="field-container">
    <div class="field" id="field"></div>
  </div>
</div>

<script>
const field = document.getElementById("field");
let draggedElement = null;
let offsetX, offsetY;
let playerNames = Array(18).fill("");

// =============================================
// Desenhar campo com linhas reais (SVG)
// =============================================
function drawFieldLines() {
  const svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
  svg.setAttribute("width", "100%");
  svg.setAttribute("height", "100%");
  svg.style.position = "absolute";
  svg.style.top = "0";
  svg.style.left = "0";
  svg.style.pointerEvents = "none";

  const w = 920, h = 520;
  const scale = (x) => x * w / 105;  // Campo FIFA ~105×68m
  const lines = [];

  // Contorno + meio-campo
  lines.push(`<rect x="0" y="0" width="${w}" height="${h}" fill="none" stroke="#fff" stroke-width="4" opacity="0.8"/>`);
  lines.push(`<line x1="${w/2}" y1="0" x2="${w/2}" y2="${h}" stroke="#fff" stroke-width="3" opacity="0.7"/>`);

  // Círculo central
  lines.push(`<circle cx="${w/2}" cy="${h/2}" r="${scale(9.15)}" fill="none" stroke="#fff" stroke-width="3" opacity="0.7"/>`);
  lines.push(`<circle cx="${w/2}" cy="${h/2}" r="4" fill="#fff"/>`);

  // Áreas penais (completo)
  const penaltyAreaW = scale(16.5), penaltyAreaH = scale(40.3);
  const goalAreaW   = scale(5.5),   goalAreaH   = scale(18.3);
  lines.push(`<rect x="0" y="${(h-penaltyAreaH)/2}" width="${penaltyAreaW}" height="${penaltyAreaH}" fill="none" stroke="#fff" stroke-width="3" opacity="0.75"/>`);
  lines.push(`<rect x="${w-penaltyAreaW}" y="${(h-penaltyAreaH)/2}" width="${penaltyAreaW}" height="${penaltyAreaH}" fill="none" stroke="#fff" stroke-width="3" opacity="0.75"/>`);
  lines.push(`<rect x="0" y="${(h-goalAreaH)/2}" width="${goalAreaW}" height="${goalAreaH}" fill="none" stroke="#fff" stroke-width="2" opacity="0.75"/>`);
  lines.push(`<rect x="${w-goalAreaW}" y="${(h-goalAreaH)/2}" width="${goalAreaW}" height="${goalAreaH}" fill="none" stroke="#fff" stroke-width="2" opacity="0.75"/>`);

  // Pontos de penálti + semicírculos
  lines.push(`<circle cx="${scale(11)}" cy="${h/2}" r="2" fill="#fff"/>`);
  lines.push(`<circle cx="${w - scale(11)}" cy="${h/2}" r="2" fill="#fff"/>`);
  lines.push(`<path d="M ${scale(11)} ${h/2} A ${scale(9.15)} ${scale(9.15)} 0 0 1 ${scale(11)+scale(18.3)} ${h/2 - scale(9.15)}" fill="none" stroke="#fff" stroke-width="3" opacity="0.7"/>`);
  lines.push(`<path d="M ${w - scale(11)} ${h/2} A ${scale(9.15)} ${scale(9.15)} 0 0 0 ${w - scale(11)-scale(18.3)} ${h/2 - scale(9.15)}" fill="none" stroke="#fff" stroke-width="3" opacity="0.7"/>`);

  svg.innerHTML = lines.join("");
  field.appendChild(svg);
}

// =============================================
// Plantel numerado
// =============================================
function initPlantel() {
  const list = document.getElementById("playerList");
  list.innerHTML = "";
  for (let i = 0; i < 18; i++) {
    const slot = document.createElement("div");
    slot.className = "player-slot";
    slot.draggable = true;
    slot.dataset.index = i;

    const num = document.createElement("div");
    num.className = "player-number";
    num.innerText = i + 1;

    const name = document.createElement("div");
    name.className = "player-name";
    name.contentEditable = true;
    name.innerText = playerNames[i] || "";
    name.oninput = () => { playerNames[i] = name.innerText.trim(); syncFieldNames(); };

    slot.appendChild(num);
    slot.appendChild(name);

    slot.addEventListener("dragstart", (e) => {
      draggedElement = slot;
      e.dataTransfer.setData("text/plain", i);
    });

    list.appendChild(slot);
  }
}

function addExtraPlayer() {
  const nameInput = document.getElementById("newPlayer").value.trim();
  if (!nameInput) return;
  const slot = document.createElement("div");
  slot.className = "player-slot";
  slot.draggable = true;

  const num = document.createElement("div");
  num.className = "player-number";
  num.innerText = "?";

  const name = document.createElement("div");
  name.className = "player-name";
  name.contentEditable = true;
  name.innerText = nameInput;

  slot.appendChild(num);
  slot.appendChild(name);
  slot.addEventListener("dragstart", (e) => {
    draggedElement = slot;
    e.dataTransfer.setData("text/plain", nameInput);
  });

  document.getElementById("playerList").appendChild(slot);
  document.getElementById("newPlayer").value = "";
}

// =============================================
// Formações (posições base)
// =============================================
const formations = {
  "352Atual": [
    [0.06, 0.50], [0.22, 0.32], [0.22, 0.50], [0.22, 0.68],
    [0.42, 0.12], [0.42, 0.32], [0.42, 0.50], [0.42, 0.68], [0.42, 0.88],
    [0.70, 0.35], [0.70, 0.65]
  ],
  "433": [[0.06,0.5],[0.20,0.25],[0.20,0.50],[0.20,0.75],[0.20,0.90],[0.40,0.25],[0.40,0.50],[0.40,0.75],[0.68,0.20],[0.68,0.50],[0.68,0.80]],
  "442": [[0.06,0.5],[0.20,0.25],[0.20,0.50],[0.20,0.75],[0.20,0.90],[0.42,0.20],[0.42,0.45],[0.42,0.55],[0.42,0.80],[0.70,0.35],[0.70,0.65]],
  "4231": [[0.06,0.5],[0.20,0.25],[0.20,0.50],[0.20,0.75],[0.20,0.90],[0.38,0.35],[0.38,0.65],[0.55,0.20],[0.55,0.40],[0.55,0.60],[0.72,0.50]],
  "532": [[0.06,0.5],[0.18,0.20],[0.18,0.40],[0.18,0.60],[0.18,0.80],[0.18,0.95],[0.40,0.25],[0.40,0.50],[0.40,0.75],[0.68,0.35],[0.68,0.65]]
};

function generateFormation() {
  field.innerHTML = "";
  drawFieldLines();

  const sel = document.getElementById("formation").value;
  const posArray = formations[sel] || formations["352Atual"];

  posArray.forEach((p, i) => {
    const div = document.createElement("div");
    div.className = "player";
    div.contentEditable = true;
    div.dataset.pos = (i + 1).toString();
    div.dataset.plantelIndex = i;  // associa ao plantel 0-10
    div.innerText = playerNames[i] || "";
    div.style.left = (p[0] * 920) + "px";
    div.style.top  = (p[1] * 520) + "px";

    makeDraggable(div);
    field.appendChild(div);
  });
}

function syncFieldNames() {
  const players = field.querySelectorAll(".player");
  players.forEach(p => {
    const idx = parseInt(p.dataset.plantelIndex);
    if (!isNaN(idx) && playerNames[idx] !== undefined) {
      p.innerText = playerNames[idx];
    }
  });
}

// =============================================
// Drag & Drop (do plantel para campo + mover no campo)
// =============================================
field.addEventListener("dragover", (e) => e.preventDefault());

field.addEventListener("drop", (e) => {
  e.preventDefault();
  if (!draggedElement) return;

  const data = e.dataTransfer.getData("text/plain");
  let name = "";
  let index = parseInt(data);

  if (!isNaN(index)) {
    name = playerNames[index] || document.querySelectorAll(".player-name")[index].innerText.trim();
  } else {
    name = data; // extra player
  }

  // Cria ou atualiza jogador no campo
  const existing = Array.from(field.querySelectorAll(".player")).find(p => p.dataset.plantelIndex == index);
  if (existing) {
    existing.innerText = name;
    return;
  }

  // Novo jogador no local do drop
  const rect = field.getBoundingClientRect();
  const div = document.createElement("div");
  div.className = "player";
  div.contentEditable = true;
  div.innerText = name;
  div.dataset.pos = "?";
  if (!isNaN(index)) div.dataset.plantelIndex = index;

  let left = e.clientX - rect.left - 38;
  let top  = e.clientY - rect.top  - 23;
  left = Math.max(0, Math.min(920-76, Math.round(left/20)*20));
  top  = Math.max(0, Math.min(520-46, Math.round(top/20)*20));

  div.style.left = left + "px";
  div.style.top  = top + "px";

  makeDraggable(div);
  field.appendChild(div);
});

function makeDraggable(el) {
  let isDragging = false;

  const start = (e) => {
    isDragging = true;
    const clientX = e.clientX || e.touches?.[0].clientX;
    const clientY = e.clientY || e.touches?.[0].clientY;
    offsetX = clientX - el.getBoundingClientRect().left;
    offsetY = clientY - el.getBoundingClientRect().top;
    el.style.zIndex = 100;
  };

  const move = (e) => {
    if (!isDragging) return;
    e.preventDefault();
    const clientX = e.clientX || e.touches?.[0].clientX;
    const clientY = e.clientY || e.touches?.[0].clientY;
    let newLeft = clientX - offsetX - field.getBoundingClientRect().left;
    let newTop  = clientY - offsetY - field.getBoundingClientRect().top;

    newLeft = Math.round(newLeft / 20) * 20;
    newTop  = Math.round(newTop  / 20) * 20;
    newLeft = Math.max(0, Math.min(920-76, newLeft));
    newTop  = Math.max(0, Math.min(520-46, newTop));

    el.style.left = newLeft + "px";
    el.style.top  = newTop + "px";
  };

  const end = () => { isDragging = false; };

  el.addEventListener("mousedown", start);
  el.addEventListener("touchstart", start, {passive:false});
  document.addEventListener("mousemove", move);
  document.addEventListener("touchmove", move, {passive:false});
  document.addEventListener("mouseup", end);
  document.addEventListener("touchend", end);
}

// Limpar / Reset
function clearPositions() {
  field.querySelectorAll(".player").forEach(p => p.remove());
}

function resetAll() {
  if (!confirm("Reset total?")) return;
  document.querySelectorAll("input:not([type='date'])").forEach(el => el.value = "");
  document.getElementById("matchDate").value = "";
  playerNames.fill("");
  initPlantel();
  clearPositions();
}

// PDF (igual ao anterior, mas podes melhorar depois)
async function downloadPDF() {
  const { jsPDF } = window.jspdf;
  const canvas = await html2canvas(field, {scale:3, backgroundColor:null});
  const imgData = canvas.toDataURL("image/png");
  const pdf = new jsPDF({orientation:"landscape", unit:"mm", format:"a4"});

  const info = [
    ["Equipa", document.getElementById("teamName").value || "—"],
    ["Adversário", document.getElementById("opponent").value || "—"],
    ["Data", document.getElementById("matchDate").value || "—"],
    ["Competição", document.getElementById("competition").value || "—"],
    ["Formação", document.getElementById("formation").value || "—"]
  ];

  let y = 12;
  info.forEach(([label, val]) => {
    pdf.text(`${label}: ${val}`, 12, y);
    y += 8;
  });

  pdf.addImage(imgData, "PNG", 10, y + 5, 270, 270 * (canvas.height/canvas.width));
  pdf.save("TactiBoard.pdf");
}

// Início
initPlantel();
drawFieldLines();
</script>
</body>
</html>
