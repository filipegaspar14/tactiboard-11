<!DOCTYPE html>
<html lang="pt">
<head>
<meta charset="UTF-8">
<title>TactiBoard 11 – Campo Verde 2D</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<style>
  body { margin:0; font-family:'Segoe UI',sans-serif; background:#f8f9fa; color:#111; }
  header { padding:16px; background:#22c55e; text-align:center; font-size:26px; font-weight:bold; color:white; }
  .container { display:flex; gap:20px; padding:16px; max-width:100%; margin:auto; flex-wrap:wrap; }
  .sidebar { width:320px; min-width:280px; background:#e0f2e9; padding:16px; border-radius:10px; box-shadow:0 2px 10px rgba(0,0,0,0.1); }
  .sidebar input, .sidebar select, .sidebar button { width:100%; margin:8px 0; padding:10px; border-radius:6px; border:1px solid #ccc; box-sizing:border-box; font-size:14px; }
  .sidebar button.primary   { background:#16a34a; color:white; border:none; cursor:pointer; }
  .sidebar button.secondary { background:#6b7280; color:white; border:none; cursor:pointer; }
  .sidebar button.danger    { background:#ef4444; color:white; border:none; cursor:pointer; }
  .sidebar button.active    { background:#eab308; color:black; }

  .player-slot { display:flex; align-items:center; background:white; border:1px solid #ddd; border-radius:6px; margin:6px 0; padding:6px; font-weight:bold; cursor:grab; }
  .player-number { width:36px; text-align:center; background:#dcfce7; border-radius:4px; padding:4px 0; margin-right:8px; color:#166534; }
  .player-name { flex:1; padding:6px; min-height:24px; }
  .player-name:focus { outline:2px solid #16a34a; background:#f0fdf4; }

  .field-container { flex:1; min-width:600px; text-align:center; }
  .field { width:100%; max-width:920px; height:520px; background:#86efac; margin:0 auto; position:relative; border:4px solid #14532d; border-radius:8px; overflow:hidden; box-shadow:0 4px 20px rgba(0,0,0,0.15); }

  .player { 
    position:absolute; width:76px; height:46px; border-radius:10px; 
    text-align:center; line-height:46px; font-size:13px; font-weight:bold; 
    cursor:move; background:rgba(255,255,255,0.94); color:#111; 
    border:1px solid #555; box-shadow:0 2px 8px rgba(0,0,0,0.25); 
    user-select:none; pointer-events:auto; 
  }
  .player.opponent {
    width: 52px; height: 52px; border-radius: 50%; 
    background: rgba(239, 68, 68, 0.88); color: white; 
    line-height: 52px; font-size: 15px; border: 2px solid #991b1b; 
    cursor: default; pointer-events: none;
  }
  .player::before { 
    content:attr(data-pos); position:absolute; top:-20px; left:50%; 
    transform:translateX(-50%); font-size:11px; color:#222; font-weight:normal; 
  }
  .player.opponent::before { color: #7f1d1d; font-size: 13px; top: -22px; }

  .drawing-layer { position:absolute; top:0; left:0; width:100%; height:100%; pointer-events:none; }
  .status { margin:8px 0; font-size:13px; color:#555; min-height:20px; }
</style>
</head>
<body>

<header>⚽ TactiBoard 11 – Campo Verde 2D</header>

<div class="container">
  <div class="sidebar">
    <input type="text" id="teamName" placeholder="Nome da Equipa">
    <input type="text" id="opponent" placeholder="Adversário">

    <select id="formation" onchange="generateFormation()">
      <option value="352Atual" selected>3-5-2 (Nossa equipa)</option>
      <option value="433">4-3-3</option>
      <option value="442">4-4-2</option>
      <option value="4231">4-2-3-1</option>
      <option value="532">5-3-2</option>
    </select>

    <select id="opponentFormation" onchange="updateOpponent()">
      <option value="none" selected>Sem adversário</option>
      <option value="352Atual">3-5-2</option>
      <option value="433">4-3-3</option>
      <option value="442">4-4-2</option>
      <option value="4231">4-2-3-1</option>
      <option value="532">5-3-2</option>
    </select>

    <label style="display:block; margin:12px 0;">
      <input type="checkbox" id="showOpponent" onchange="updateOpponent()"> Mostrar equipa adversária
    </label>

    <button class="primary" onclick="generateFormation()">Aplicar formação nossa</button>
    <button class="secondary" onclick="clearPositions()">Limpar posições nossas</button>
    <button class="danger" onclick="resetAll()">Reset total</button>

    <div style="margin-top:20px;">
      <h3>Plantel (1–18)</h3>
      <div id="playerList"></div>
      <input type="text" id="newPlayer" placeholder="Jogador extra (19+)">
      <button class="primary" onclick="addExtraPlayer()">Adicionar</button>
    </div>

    <button class="primary" style="margin-top:16px;" onclick="downloadPDF()">Download PDF</button>
  </div>

  <div class="field-container">
    <div class="field" id="field">
      <svg class="drawing-layer" id="drawingLayer"></svg>
    </div>
  </div>
</div>

<script>
const field = document.getElementById("field");
let draggedElement = null;
let offsetX, offsetY;
let playerNames = Array(18).fill("");

// Formações (posições relativas 0–1)
const formations = {
  "352Atual": [
    [0.06, 0.50], [0.22, 0.32], [0.22, 0.50], [0.22, 0.68],
    [0.42, 0.12], [0.42, 0.32], [0.42, 0.50], [0.42, 0.68], [0.42, 0.88],
    [0.70, 0.35], [0.70, 0.65]
  ],
  "433": [[0.06,0.5],[0.20,0.25],[0.20,0.50],[0.20,0.75],[0.20,0.90],[0.40,0.25],[0.40,0.50],[0.40,0.75],[0.68,0.20],[0.68,0.50],[0.68,0.80]],
  "442": [[0.06,0.5],[0.20,0.25],[0.20,0.50],[0.20,0.75],[0.20,0.90],[0.42,0.20],[0.42,0.45],[0.42,0.55],[0.42,0.80],[0.70,0.35],[0.70,0.65]],
  "4231": [[0.06,0.5],[0.20,0.25],[0.20,0.50],[0.20,0.75],[0.20,0.90],[0.38,0.35],[0.38,0.65],[0.55,0.20],[0.55,0.40],[0.55,0.60],[0.72,0.50]],
  "532": [[0.06,0.5],[0.18,0.20],[0.18,0.40],[0.18,0.60],[0.18,0.80],[0.18,0.95],[0.40,0.25],[0.40,0.50],[0.40,0.75],[0.68,0.35],[0.68,0.65]]
};

// Desenhar linhas do campo (versão simplificada – podes manter a versão completa anterior)
function drawFieldLines() {
  // Aqui vai a função drawFieldLines() completa que já tinhas (SVG com linhas FIFA)
  // Por brevidade estou a omitir, mas mantém a que já funciona corretamente no teu código
  const svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
  svg.setAttribute("width", "100%");
  svg.setAttribute("height", "100%");
  svg.style.position = "absolute";
  svg.style.top = "0";
  svg.style.left = "0";
  svg.style.pointerEvents = "none";
  // ... adiciona as linhas aqui (contorno, meio-campo, áreas, etc.)
  field.insertBefore(svg, field.firstChild);
}

// Plantel nossa equipa
function initPlantel() {
  const list = document.getElementById("playerList");
  list.innerHTML = "";
  for (let i = 0; i < 18; i++) {
    const slot = document.createElement("div");
    slot.className = "player-slot";
    slot.draggable = true;
    slot.dataset.index = i;

    const num = document.createElement("div");
    num.className = "player-number";
    num.innerText = i + 1;

    const nameDiv = document.createElement("div");
    nameDiv.className = "player-name";
    nameDiv.contentEditable = true;
    nameDiv.innerText = playerNames[i] || "";
    nameDiv.oninput = () => {
      playerNames[i] = nameDiv.innerText.trim();
      syncFieldNames();
    };

    slot.appendChild(num);
    slot.appendChild(nameDiv);

    slot.addEventListener("dragstart", e => {
      draggedElement = slot;
      e.dataTransfer.setData("text/plain", i.toString());
    });

    list.appendChild(slot);
  }
}

// Gerar / atualizar nossa equipa
function generateFormation() {
  field.querySelectorAll(".player:not(.opponent)").forEach(p => p.remove());

  const key = document.getElementById("formation").value;
  const posArray = formations[key] || formations["352Atual"];

  posArray.forEach((relPos, i) => {
    if (i >= 11) return;
    const div = document.createElement("div");
    div.className = "player";
    div.contentEditable = true;
    div.dataset.pos = (i + 1).toString();
    div.dataset.plantelIndex = i.toString();
    div.innerText = playerNames[i] || "";
    div.style.left = (relPos[0] * field.clientWidth) + "px";
    div.style.top  = (relPos[1] * 520) + "px";
    makeDraggable(div);
    field.appendChild(div);
  });
}

// Atualizar adversário (bolinhas vermelhas)
function updateOpponent() {
  field.querySelectorAll(".opponent").forEach(el => el.remove());

  const show = document.getElementById("showOpponent").checked;
  if (!show) return;

  const key = document.getElementById("opponentFormation").value;
  if (key === "none") return;

  const posArray = formations[key] || formations["352Atual"];

  posArray.forEach((relPos, i) => {
    if (i >= 11) return;
    const div = document.createElement("div");
    div.className = "player opponent";
    div.dataset.pos = (i + 1).toString();
    div.innerText = i + 1;
    div.style.left = (relPos[0] * field.clientWidth) + "px";
    div.style.top  = (relPos[1] * 520) + "px";
    field.appendChild(div);
  });
}

// Sincronizar nomes da nossa equipa
function syncFieldNames() {
  document.querySelectorAll(".player:not(.opponent)").forEach(p => {
    const idx = parseInt(p.dataset.plantelIndex);
    if (!isNaN(idx) && playerNames[idx] !== undefined) {
      p.innerText = playerNames[idx];
    }
  });
}

// Drag & drop (só para nossa equipa – adversário não arrasta)
field.addEventListener("dragover", e => e.preventDefault());

field.addEventListener("drop", e => {
  e.preventDefault();
  if (!draggedElement) return;
  // ... mantém a lógica de drop que já tinhas (adicionar/mover nossa equipa)
});

// makeDraggable (igual ao anterior – só para .player não .opponent)

// Inicialização
initPlantel();
drawFieldLines();
generateFormation();
updateOpponent();
</script>
</body>
</html>
