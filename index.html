<!DOCTYPE html>
<html lang="pt">
<head>
<meta charset="UTF-8">
<title>TactiBoard 11 – Campo Verde 2D</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<style>
  body {
    margin: 0;
    font-family: 'Segoe UI', sans-serif;
    background: #f8f9fa;
    color: #111;
  }
  header {
    padding: 16px;
    background: #22c55e;
    text-align: center;
    font-size: 26px;
    font-weight: bold;
    color: white;
  }
  .container {
    display: flex;
    gap: 24px;
    padding: 20px;
    max-width: 1400px;
    margin: auto;
  }
  .sidebar {
    width: 340px;
    background: #e0f2e9;
    padding: 20px;
    border-radius: 12px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.08);
  }
  .sidebar input,
  .sidebar select {
    width: 100%;
    margin-bottom: 12px;
    padding: 10px;
    border-radius: 6px;
    border: 1px solid #ccc;
    box-sizing: border-box;
  }
  .sidebar button {
    width: 100%;
    padding: 12px;
    margin: 6px 0;
    border: none;
    border-radius: 8px;
    font-weight: bold;
    cursor: pointer;
  }
  .sidebar button.primary   { background: #16a34a; color: white; }
  .sidebar button.secondary { background: #6b7280; color: white; }
  .sidebar button.danger    { background: #ef4444; color: white; }

  .player-slot {
    display: flex;
    align-items: center;
    background: white;
    border: 1px solid #ddd;
    border-radius: 6px;
    margin: 6px 0;
    padding: 6px;
    font-weight: bold;
    cursor: grab;
  }
  .player-number {
    width: 36px;
    text-align: center;
    background: #dcfce7;
    border-radius: 4px;
    padding: 4px 0;
    margin-right: 8px;
    color: #166534;
    font-size: 15px;
  }
  .player-name {
    flex: 1;
    padding: 6px;
    border-radius: 4px;
    min-height: 24px;
  }
  .player-name[contenteditable="true"]:focus {
    outline: 2px solid #16a34a;
    background: #f0fdf4;
  }

  .field-container {
    flex: 1;
    text-align: center;
  }
  .field {
    width: 920px;
    height: 520px;
    background: #86efac;
    margin: auto;
    position: relative;
    border: 4px solid #14532d;
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 0 4px 20px rgba(0,0,0,0.15);
  }
  .player {
    position: absolute;
    width: 76px;
    height: 46px;
    border-radius: 10px;
    text-align: center;
    line-height: 46px;
    font-size: 13px;
    font-weight: bold;
    cursor: move;
    background: rgba(255,255,255,0.94);
    color: #111;
    border: 1px solid #555;
    box-shadow: 0 2px 8px rgba(0,0,0,0.25);
    user-select: none;
  }
  .player::before {
    content: attr(data-pos);
    position: absolute;
    top: -20px;
    left: 50%;
    transform: translateX(-50%);
    font-size: 11px;
    color: #222;
    font-weight: normal;
  }
</style>
</head>
<body>

<header>⚽ TactiBoard 11 – Campo Verde 2D</header>

<div class="container">
  <div class="sidebar">
    <input type="text" id="teamName" placeholder="Nome da Equipa">
    <input type="text" id="opponent" placeholder="Adversário">
    <input type="date" id="matchDate">
    <input type="text" id="competition" placeholder="Competição">

    <select id="formation">
      <option value="352Atual" selected>3-5-2 ATUAL (Preset)</option>
      <option value="433">4-3-3</option>
      <option value="442">4-4-2</option>
      <option value="4231">4-2-3-1</option>
      <option value="532">5-3-2</option>
    </select>

    <button class="primary" onclick="generateFormation()">Aplicar Formação</button>
    <button class="secondary" onclick="clearPositions()">Limpar posições</button>
    <button class="danger" onclick="resetAll()">Reset total</button>
    <button class="primary" onclick="downloadPDF()">Download PDF</button>

    <div style="margin-top: 24px;">
      <h3>Plantel (1–18)</h3>
      <div id="playerList"></div>
      <input type="text" id="newPlayer" placeholder="Adicionar jogador extra (19+)">
      <button class="primary" onclick="addExtraPlayer()">Adicionar extra</button>
      <p style="font-size:12px; color:#555; margin-top:8px;">
        Edita os nomes • Arrasta para o campo
      </p>
    </div>
  </div>

  <div class="field-container">
    <div class="field" id="field"></div>
  </div>
</div>

<script>
const field = document.getElementById("field");
let draggedElement = null;
let offsetX, offsetY;
let playerNames = Array(18).fill("");

// =============================================
// Campo com linhas corrigidas e realistas
// =============================================
function drawFieldLines() {
  const svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
  svg.setAttribute("width", "100%");
  svg.setAttribute("height", "100%");
  svg.style.position = "absolute";
  svg.style.top = "0";
  svg.style.left = "0";
  svg.style.pointerEvents = "none";

  const w = 920;
  const h = 520;

  const scaleX = w / 105;
  const scaleY = h / 68;
  const scale  = (v) => v * (scaleX + scaleY) / 2;

  const lines = [];

  // Contorno
  lines.push(`<rect x="0" y="0" width="${w}" height="${h}" fill="none" stroke="#ffffff" stroke-width="4" opacity="0.85"/>`);

  // Meio-campo
  lines.push(`<line x1="${w/2}" y1="0" x2="${w/2}" y2="${h}" stroke="#ffffff" stroke-width="3" opacity="0.75"/>`);

  // Círculo central
  lines.push(`<circle cx="${w/2}" cy="${h/2}" r="${scale(9.15)}" fill="none" stroke="#ffffff" stroke-width="3" opacity="0.75"/>`);
  lines.push(`<circle cx="${w/2}" cy="${h/2}" r="3" fill="#ffffff"/>`);

  // Áreas penais grandes (16.5 × 40.32 m)
  const paW = scale(16.5);
  const paH = scale(40.32);
  lines.push(`<rect x="0" y="${(h-paH)/2}" width="${paW}" height="${paH}" fill="none" stroke="#ffffff" stroke-width="3" opacity="0.8"/>`);
  lines.push(`<rect x="${w-paW}" y="${(h-paH)/2}" width="${paW}" height="${paH}" fill="none" stroke="#ffffff" stroke-width="3" opacity="0.8"/>`);

  // Áreas pequenas (5.5 × 18.32 m)
  const gaW = scale(5.5);
  const gaH = scale(18.32);
  lines.push(`<rect x="0" y="${(h-gaH)/2}" width="${gaW}" height="${gaH}" fill="none" stroke="#ffffff" stroke-width="2.5" opacity="0.8"/>`);
  lines.push(`<rect x="${w-gaW}" y="${(h-gaH)/2}" width="${gaW}" height="${gaH}" fill="none" stroke="#ffffff" stroke-width="2.5" opacity="0.8"/>`);

  // Pontos de penálti
  const penX = scale(11);
  lines.push(`<circle cx="${penX}" cy="${h/2}" r="2.5" fill="#ffffff"/>`);
  lines.push(`<circle cx="${w-penX}" cy="${h/2}" r="2.5" fill="#ffffff"/>`);

  // Semicírculos da área penal – CORRIGIDO
  const arcR = scale(9.15);
  // Esquerda (abre para direita)
  lines.push(`<path d="M ${penX} ${h/2} A ${arcR} ${arcR} 0 0 1 ${penX + scale(18.3)} ${h/2 - arcR}" fill="none" stroke="#ffffff" stroke-width="3" opacity="0.8"/>`);
  lines.push(`<path d="M ${penX} ${h/2} A ${arcR} ${arcR} 0 0 0 ${penX + scale(18.3)} ${h/2 + arcR}" fill="none" stroke="#ffffff" stroke-width="3" opacity="0.8"/>`);
  // Direita (abre para esquerda)
  lines.push(`<path d="M ${w-penX} ${h/2} A ${arcR} ${arcR} 0 0 0 ${w-penX - scale(18.3)} ${h/2 - arcR}" fill="none" stroke="#ffffff" stroke-width="3" opacity="0.8"/>`);
  lines.push(`<path d="M ${w-penX} ${h/2} A ${arcR} ${arcR} 0 0 1 ${w-penX - scale(18.3)} ${h/2 + arcR}" fill="none" stroke="#ffffff" stroke-width="3" opacity="0.8"/>`);

  // Bandeirinhas de canto (raio ~1m)
  const cr = scale(1);
  lines.push(`<path d="M 0 0 A ${cr} ${cr} 0 0 1 ${cr*2} ${cr*2}" fill="none" stroke="#ffffff" stroke-width="3" opacity="0.7"/>`);
  lines.push(`<path d="M ${w} 0 A ${cr} ${cr} 0 0 0 ${w - cr*2} ${cr*2}" fill="none" stroke="#ffffff" stroke-width="3" opacity="0.7"/>`);
  lines.push(`<path d="M 0 ${h} A ${cr} ${cr} 0 0 0 ${cr*2} ${h - cr*2}" fill="none" stroke="#ffffff" stroke-width="3" opacity="0.7"/>`);
  lines.push(`<path d="M ${w} ${h} A ${cr} ${cr} 0 0 1 ${w - cr*2} ${h - cr*2}" fill="none" stroke="#ffffff" stroke-width="3" opacity="0.7"/>`);

  svg.innerHTML = lines.join("\n");
  field.appendChild(svg);
}

// =============================================
// Plantel
// =============================================
function initPlantel() {
  const list = document.getElementById("playerList");
  list.innerHTML = "";
  for (let i = 0; i < 18; i++) {
    const slot = document.createElement("div");
    slot.className = "player-slot";
    slot.draggable = true;
    slot.dataset.index = i;

    const num = document.createElement("div");
    num.className = "player-number";
    num.innerText = i + 1;

    const nameDiv = document.createElement("div");
    nameDiv.className = "player-name";
    nameDiv.contentEditable = true;
    nameDiv.innerText = playerNames[i] || "";
    nameDiv.oninput = () => {
      playerNames[i] = nameDiv.innerText.trim();
      syncFieldNames();
    };

    slot.appendChild(num);
    slot.appendChild(nameDiv);

    slot.addEventListener("dragstart", (e) => {
      draggedElement = slot;
      e.dataTransfer.setData("text/plain", i.toString());
    });

    list.appendChild(slot);
  }
}

function addExtraPlayer() {
  const val = document.getElementById("newPlayer").value.trim();
  if (!val) return;

  const slot = document.createElement("div");
  slot.className = "player-slot";
  slot.draggable = true;

  const num = document.createElement("div");
  num.className = "player-number";
  num.innerText = "?";

  const nameDiv = document.createElement("div");
  nameDiv.className = "player-name";
  nameDiv.contentEditable = true;
  nameDiv.innerText = val;

  slot.appendChild(num);
  slot.appendChild(nameDiv);

  slot.addEventListener("dragstart", (e) => {
    draggedElement = slot;
    e.dataTransfer.setData("text/plain", "extra:" + val);
  });

  document.getElementById("playerList").appendChild(slot);
  document.getElementById("newPlayer").value = "";
}

// =============================================
// Formações
// =============================================
const formations = {
  "352Atual": [
    [0.06, 0.50], [0.22, 0.32], [0.22, 0.50], [0.22, 0.68],
    [0.42, 0.12], [0.42, 0.32], [0.42, 0.50], [0.42, 0.68], [0.42, 0.88],
    [0.70, 0.35], [0.70, 0.65]
  ],
  "433": [[0.06,0.5],[0.20,0.25],[0.20,0.50],[0.20,0.75],[0.20,0.90],[0.40,0.25],[0.40,0.50],[0.40,0.75],[0.68,0.20],[0.68,0.50],[0.68,0.80]],
  "442": [[0.06,0.5],[0.20,0.25],[0.20,0.50],[0.20,0.75],[0.20,0.90],[0.42,0.20],[0.42,0.45],[0.42,0.55],[0.42,0.80],[0.70,0.35],[0.70,0.65]],
  "4231": [[0.06,0.5],[0.20,0.25],[0.20,0.50],[0.20,0.75],[0.20,0.90],[0.38,0.35],[0.38,0.65],[0.55,0.20],[0.55,0.40],[0.55,0.60],[0.72,0.50]],
  "532": [[0.06,0.5],[0.18,0.20],[0.18,0.40],[0.18,0.60],[0.18,0.80],[0.18,0.95],[0.40,0.25],[0.40,0.50],[0.40,0.75],[0.68,0.35],[0.68,0.65]]
};

function generateFormation() {
  field.innerHTML = "";
  drawFieldLines();

  const key = document.getElementById("formation").value;
  const pos = formations[key] || formations["352Atual"];

  pos.forEach((p, i) => {
    if (i >= 11) return; // só 11 jogadores em campo

    const div = document.createElement("div");
    div.className = "player";
    div.contentEditable = true;
    div.dataset.pos = (i + 1).toString();
    div.dataset.plantelIndex = i.toString();
    div.innerText = playerNames[i] || "";
    div.style.left = (p[0] * 920) + "px";
    div.style.top  = (p[1] * 520) + "px";

    makeDraggable(div);
    field.appendChild(div);
  });
}

function syncFieldNames() {
  document.querySelectorAll(".player").forEach(p => {
    const idx = parseInt(p.dataset.plantelIndex);
    if (!isNaN(idx) && playerNames[idx] !== undefined) {
      p.innerText = playerNames[idx];
    }
  });
}

// =============================================
// Drag & Drop
// =============================================
field.addEventListener("dragover", e => e.preventDefault());

field.addEventListener("drop", e => {
  e.preventDefault();
  if (!draggedElement) return;

  const data = e.dataTransfer.getData("text/plain");
  let name = "";
  let plantelIdx = null;

  if (data.startsWith("extra:")) {
    name = data.substring(6);
  } else {
    const idx = parseInt(data);
    if (!isNaN(idx)) {
      plantelIdx = idx;
      name = playerNames[idx] || "";
    }
  }

  const rect = field.getBoundingClientRect();
  let left = e.clientX - rect.left - 38;
  let top  = e.clientY - rect.top  - 23;
  left = Math.max(0, Math.min(920-76, Math.round(left/20)*20));
  top  = Math.max(0, Math.min(520-46, Math.round(top/20)*20));

  // Verificar se já existe jogador associado a este índice
  let existing = null;
  if (plantelIdx !== null) {
    existing = field.querySelector(`.player[data-plantel-index="${plantelIdx}"]`);
  }

  if (existing) {
    existing.innerText = name;
    existing.style.left = left + "px";
    existing.style.top  = top  + "px";
    return;
  }

  // Criar novo
  const div = document.createElement("div");
  div.className = "player";
  div.contentEditable = true;
  div.innerText = name;
  div.dataset.pos = "?";
  if (plantelIdx !== null) div.dataset.plantelIndex = plantelIdx;
  div.style.left = left + "px";
  div.style.top  = top + "px";

  makeDraggable(div);
  field.appendChild(div);
});

function makeDraggable(el) {
  let isDragging = false;

  const start = e => {
    isDragging = true;
    const clientX = e.clientX || (e.touches && e.touches[0].clientX);
    const clientY = e.clientY || (e.touches && e.touches[0].clientY);
    const rect = el.getBoundingClientRect();
    offsetX = clientX - rect.left;
    offsetY = clientY - rect.top;
    el.style.zIndex = 100;
    e.preventDefault();
  };

  const move = e => {
    if (!isDragging) return;
    e.preventDefault();
    const clientX = e.clientX || (e.touches && e.touches[0].clientX);
    const clientY = e.clientY || (e.touches && e.touches[0].clientY);
    let newLeft = clientX - offsetX - field.getBoundingClientRect().left;
    let newTop  = clientY - offsetY - field.getBoundingClientRect().top;

    newLeft = Math.round(newLeft / 20) * 20;
    newTop  = Math.round(newTop  / 20) * 20;
    newLeft = Math.max(0, Math.min(920-76, newLeft));
    newTop  = Math.max(0, Math.min(520-46, newTop));

    el.style.left = newLeft + "px";
    el.style.top  = newTop + "px";
  };

  const end = () => { isDragging = false; };

  el.addEventListener("mousedown", start);
  el.addEventListener("touchstart", start, {passive: false});
  document.addEventListener("mousemove", move);
  document.addEventListener("touchmove", move, {passive: false});
  document.addEventListener("mouseup", end);
  document.addEventListener("touchend", end);
}

// =============================================
// Limpar / Reset
// =============================================
function clearPositions() {
  field.innerHTML = "";
  drawFieldLines();
}

function resetAll() {
  if (!confirm("Reset total? Perdes tudo.")) return;
  document.getElementById("teamName").value = "";
  document.getElementById("opponent").value = "";
  document.getElementById("matchDate").value = "";
  document.getElementById("competition").value = "";
  playerNames.fill("");
  initPlantel();
  clearPositions();
}

// =============================================
// PDF
// =============================================
async function downloadPDF() {
  const { jsPDF } = window.jspdf;
  const canvas = await html2canvas(field, {scale: 3, backgroundColor: null});
  const imgData = canvas.toDataURL("image/png");

  const pdf = new jsPDF({orientation: "landscape", unit: "mm", format: "a4"});
  let y = 12;

  const info = [
    ["Equipa",     document.getElementById("teamName").value     || "—"],
    ["Adversário", document.getElementById("opponent").value     || "—"],
    ["Data",       document.getElementById("matchDate").value    || "—"],
    ["Competição", document.getElementById("competition").value  || "—"],
    ["Formação",   document.getElementById("formation").value    || "—"]
  ];

  info.forEach(([k, v]) => {
    pdf.text(`${k}: ${v}`, 12, y);
    y += 8;
  });

  const imgW = 270;
  const imgH = (canvas.height / canvas.width) * imgW;
  pdf.addImage(imgData, "PNG", 10, y + 5, imgW, imgH);

  pdf.save("TactiBoard_CampoVerde.pdf");
}

// =============================================
// Inicialização
// =============================================
initPlantel();
drawFieldLines();
</script>
</body>
</html>
